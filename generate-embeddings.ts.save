// Run this script to generate embeddings for all existing todos
// Save as: generate-embeddings.ts and run with: npx tsx generate-embeddings.ts

import OpenAI from "openai";
import { createClient } from "@supabase/supabase-js";

const supabaseUrl = process.env.SUPABASE_URL;
const supabaseKey = process.env.SERVICE_ROLE_KEY;
const openaiKey = process.env.OPENAI_API_KEY;
const supabase = createClient(supabaseUrl, supabaseKey);
const openai = new OpenAI({ apiKey: openaiKey });

async function generateEmbeddings() {
  console.log("ğŸ” Fetching all todos...");

  // First, get ALL todos to see what we have
  const { data: allTodos, error: allError } = await supabase
    .from("todos")
    .select("*");

  if (allError) {
    console.error("âŒ Error fetching todos:", allError);
    return;
  }

  console.log(`ğŸ“Š Total todos in database: ${allTodos?.length || 0}`);
  
  if (allTodos && allTodos.length > 0) {
    console.log("ğŸ“‹ Sample todo:", {
      id: allTodos[0].id,
      title: allTodos[0].title,
      hasEmbedding: !!allTodos[0].embedding,
      embeddingLength: allTodos[0].embedding?.length || 0
    });
  }

  // Get todos that don't have embeddings
  const todos = allTodos?.filter(t => !t.embedding || t.embedding.length === 0) || [];
  
  const error = allError;

  if (error) {
    console.error("âŒ Error fetching todos:", error);
    return;
  }

  if (!todos || todos.length === 0) {
    console.log("âœ… All todos already have embeddings!");
    return;
  }

  console.log(`ğŸ“ Found ${todos.length} todos without embeddings`);

  let processed = 0;
  let failed = 0;

  for (const todo of todos) {
    try {
      console.log(`\nğŸ”„ Processing: "${todo.title}"`);

      // Create embedding text from title and notes
      const textToEmbed = `${todo.title}${todo.notes ? ` ${todo.notes}` : ""}`;

      // Generate embedding
      const response = await openai.embeddings.create({
        model: "text-embedding-3-small",
        input: textToEmbed,
      });

      const embedding = response.data[0].embedding;

      // Update todo with embedding
      const { error: updateError } = await supabase
        .from("todos")
        .update({ embedding })
        .eq("id", todo.id);

      if (updateError) {
        console.error(`âŒ Failed to update todo ${todo.id}:`, updateError);
        failed++;
      } else {
        console.log(`âœ… Generated embedding for: "${todo.title}"`);
        processed++;
      }

      // Rate limit: wait 100ms between requests
      await new Promise((resolve) => setTimeout(resolve, 100));
    } catch (err) {
      console.error(`âŒ Error processing todo ${todo.id}:`, err);
      failed++;
    }
  }

  console.log("\n" + "=".repeat(50));
  console.log(`ğŸ‰ Done! Processed: ${processed}, Failed: ${failed}`);
  console.log("=".repeat(50));
}

generateEmbeddings().catch(console.error);
